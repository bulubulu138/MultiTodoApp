# 手动选择待办关系功能说明

## 更新日期
2025-10-29

## 功能概述

在创建待办时，除了系统自动推荐的相关待办，现在还可以**手动搜索和选择**任意待办来建立关系。

## 新增功能

### 1. 手动添加关联待办

**位置**：待办表单 → "关联待办" 区域 → "手动添加关联" 卡片

**功能**：
- ✅ 提供搜索框，可搜索所有待办
- ✅ 支持按标题和标签搜索
- ✅ 自动过滤当前待办和已添加的待办
- ✅ 选择后自动添加为"扩展"关系

**使用步骤**：
1. 在"手动添加关联"区域点击搜索框
2. 输入待办标题关键词
3. 从下拉列表中选择待办
4. 待办会自动添加为"扩展"关系
5. 在"已选择的关系"区域可以修改类型或移除

### 2. 已选择关系的管理

**位置**：待办表单 → "关联待办" 区域 → "已选择的关系" 卡片

**功能**：
- ✅ 显示所有已选择的关系（包括手动添加和推荐选择的）
- ✅ 可以修改关系类型（扩展/背景/并列）
- ✅ 可以移除不需要的关系
- ✅ 使用颜色标签区分关系类型

**操作**：
- **修改类型**：点击关系类型下拉框，选择新的类型
- **移除关系**：点击"移除"按钮

### 3. 推荐待办（保留原功能）

**位置**：待办表单 → "关联待办" 区域 → 推荐列表

**功能**（保持不变）：
- 基于关键词推荐相关待办
- 显示相似度和匹配关键词
- 快速添加扩展/背景/并列关系

## UI 布局

```
┌─────────────────────────────────────┐
│ 关联待办                             │
├─────────────────────────────────────┤
│ 📌 手动添加关联                      │
│ ┌─────────────────────────────────┐ │
│ │ [搜索框: 搜索待办...]            │ │
│ │ 💡 选择后自动添加为扩展关系      │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ 💡 推荐的待办                        │
│ ┌─────────────────────────────────┐ │
│ │ 待办1 (85% 相似)                 │ │
│ │ [扩展] [背景] [并列]             │ │
│ ├─────────────────────────────────┤ │
│ │ 待办2 (72% 相似)                 │ │
│ │ [扩展] [背景] [并列]             │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ ✅ 已选择的关系 (3)                  │
│ ┌─────────────────────────────────┐ │
│ │ 待办A [扩展▼] [移除]             │ │
│ │ 待办B [背景▼] [移除]             │ │
│ │ 待办C [并列▼] [移除]             │ │
│ │ 💡 保存待办后将自动创建这些关系  │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 关系类型说明

| 类型 | 颜色 | 含义 | 使用场景 |
|------|------|------|---------|
| 扩展 | 🔵 蓝色 | A 是 B 的扩展内容 | 细化、补充、下一步行动 |
| 背景 | 🟢 绿色 | A 需要 B 的背景知识 | 前置条件、依赖关系 |
| 并列 | 🟠 橙色 | A 和 B 同等重要 | 同时进行、平行任务 |

## 实际应用示例

### 示例 1：项目管理

**当前待办**："实现用户认证功能"

**手动添加关系**：
1. 搜索"数据库设计"
2. 选择后添加为"背景"关系（因为需要先有数据库）
3. 搜索"前端登录页面"
4. 选择后保持"扩展"关系（登录页面是认证功能的扩展）

**推荐的待办**：
- "JWT Token 验证" (82% 相似) → 添加为"扩展"
- "密码加密方案" (75% 相似) → 添加为"背景"

### 示例 2：学习计划

**当前待办**："学习 React Hooks"

**手动添加关系**：
1. 搜索"React 基础概念"
2. 选择后修改为"背景"关系
3. 搜索"Redux 状态管理"
4. 选择后保持"扩展"关系

**推荐的待办**：
- "useState 和 useEffect 实践" (88% 相似) → 添加为"扩展"
- "自定义 Hook 开发" (76% 相似) → 添加为"扩展"

## 与推荐功能的配合

### 优势互补

| 功能 | 优势 | 局限 |
|------|------|------|
| **推荐** | 自动化、省时、发现意外关联 | 依赖关键词、可能遗漏 |
| **手动** | 精确控制、覆盖全面 | 需要主动搜索 |

### 最佳实践

1. **先看推荐**：
   - 快速浏览推荐列表
   - 添加明显相关的待办

2. **再手动补充**：
   - 搜索你知道相关但未被推荐的待办
   - 建立特定的依赖关系

3. **最后检查**：
   - 在"已选择的关系"中查看全部关系
   - 调整关系类型
   - 移除不合适的关系

## 技术实现

### 文件修改

**MultiTodoApp/src/renderer/components/TodoForm.tsx**

#### 1. 手动选择区域（line 472-505）

```typescript
<Card size="small" title="手动添加关联" style={{ marginBottom: 16 }}>
  <Space direction="vertical" style={{ width: '100%' }}>
    <Select
      showSearch
      placeholder="搜索待办..."
      filterOption={(input, option) =>
        (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
      }
      options={allTodos
        .filter(t => 
          t.id !== todo?.id && // 排除当前待办
          !pendingRelations.some(r => r.targetId === t.id) // 排除已添加的
        )
        .map(t => ({
          label: `${t.title}${t.tags ? ` [${t.tags}]` : ''}`,
          value: t.id,
        }))}
      onSelect={(value) => {
        const selectedTodo = allTodos.find(t => t.id === value);
        if (selectedTodo) {
          handleAddPendingRelation(selectedTodo.id!, 'extends');
          message.success(`已添加「${selectedTodo.title}」为扩展关系`);
        }
      }}
    />
  </Space>
</Card>
```

**关键点**：
- `showSearch`: 启用搜索功能
- `filterOption`: 自定义搜索过滤（支持标题和标签）
- `filter`: 排除当前待办和已添加的待办
- `onSelect`: 选择后自动添加为扩展关系

#### 2. 已选择关系管理（line 596-664）

```typescript
{pendingRelations.length > 0 && (
  <Card 
    size="small" 
    title={`已选择的关系 (${pendingRelations.length})`}
    style={{ marginTop: 16 }}
  >
    <Space direction="vertical" style={{ width: '100%' }} size="small">
      {pendingRelations.map((rel) => {
        const targetTodo = allTodos.find(t => t.id === rel.targetId);
        const relationTypeMap = {
          extends: { label: '扩展', color: 'blue' },
          background: { label: '背景', color: 'green' },
          parallel: { label: '并列', color: 'orange' }
        };
        const relInfo = relationTypeMap[rel.relationType];
        
        return (
          <div>
            <Text strong>{targetTodo.title}</Text>
            <Tag color={relInfo.color}>{relInfo.label}</Tag>
            <Select
              size="small"
              value={rel.relationType}
              onChange={(newType) => {
                handleRemovePendingRelation(rel.targetId, rel.relationType);
                handleAddPendingRelation(rel.targetId, newType);
              }}
              options={[
                { label: '扩展', value: 'extends' },
                { label: '背景', value: 'background' },
                { label: '并列', value: 'parallel' }
              ]}
            />
            <Button
              size="small"
              danger
              onClick={() => handleRemovePendingRelation(rel.targetId, rel.relationType)}
            >
              移除
            </Button>
          </div>
        );
      })}
    </Space>
  </Card>
)}
```

**关键点**：
- 显示所有待建立的关系
- 支持修改关系类型
- 支持移除关系
- 使用颜色标签区分类型

## 分词生成功能调试

### 问题
用户报告点击"生成分词"按钮没有反应。

### 调查

**检查项**：
1. ✅ `preload.ts` 有 `keywords.batchGenerate` 定义
2. ✅ `main.ts` 有 IPC 处理器 `keywords:batchGenerate`
3. ✅ `KeywordProcessor.generateKeywordsForAllTodos` 方法存在
4. ✅ `DatabaseManager.getTodosWithoutKeywords` 方法存在

**添加调试日志**（SettingsModal.tsx line 160-185）：

```typescript
const handleBatchGenerateKeywords = async () => {
  console.log('[SettingsModal] 开始批量生成关键词...');
  setGeneratingKeywords(true);
  try {
    console.log('[SettingsModal] 调用 electronAPI.keywords.batchGenerate...');
    const result = await window.electronAPI.keywords.batchGenerate();
    console.log('[SettingsModal] 收到结果:', result);
    
    if (result.success) {
      message.success(`关键词生成完成！处理了 ${result.processed}/${result.total} 个待办`);
      if (onReload) {
        console.log('[SettingsModal] 重新加载数据...');
        await onReload();
      }
    } else {
      console.error('[SettingsModal] 生成失败:', result.error);
      message.error('生成失败: ' + result.error);
    }
  } catch (error: any) {
    console.error('[SettingsModal] 捕获到错误:', error);
    message.error('生成失败: ' + error.message);
  } finally {
    console.log('[SettingsModal] 完成，设置 loading 为 false');
    setGeneratingKeywords(false);
  }
};
```

### 如何使用调试

1. 打开应用的开发者工具（View → Toggle Developer Tools）
2. 切换到 Console 标签
3. 点击"生成分词"按钮
4. 查看 Console 输出：
   - 如果看到 `[SettingsModal] 开始批量生成关键词...`，说明点击有反应
   - 如果看到 `[SettingsModal] 收到结果:`，说明 IPC 通信正常
   - 如果看到错误信息，可以定位具体问题

### 可能的原因

1. **没有待办需要生成关键词**：
   - 所有待办都已有关键词
   - 结果：`{ total: 0, processed: 0, failed: 0 }`

2. **分词服务未初始化**：
   - `keywordProcessor` 为 null
   - 结果：错误提示

3. **点击事件未绑定**：
   - Console 没有任何输出
   - 需要检查组件渲染

## 用户指南

### 创建待办时建立关系

**步骤**：
1. 点击"新建待办"
2. 输入标题和内容
3. 在"关联待办"区域：
   - 查看推荐的待办，点击关系按钮添加
   - 或在"手动添加关联"搜索框中搜索待办
4. 在"已选择的关系"中查看和管理关系
5. 点击"确定"保存

### 修改已添加的关系

**在保存前**：
1. 在"已选择的关系"区域
2. 点击关系类型下拉框，选择新类型
3. 或点击"移除"按钮删除关系

**保存后**：
1. 点击待办卡片
2. 在右侧抽屉中查看"关系上下文"
3. 点击关系后的操作按钮修改或删除

### 搜索技巧

**按标题搜索**：
```
输入: "认证"
结果: "用户认证"、"JWT认证"、"OAuth认证"
```

**按标签搜索**：
```
输入: "前端"
结果: 所有带 [前端] 标签的待办
```

**组合搜索**：
```
输入: "React 组件"
结果: 标题包含"React"或"组件"的待办
```

## 常见问题

### Q1：为什么搜索不到某个待办？

**A**：可能的原因：
1. 该待办已经添加了关系（已添加的不会再显示）
2. 该待办就是当前正在创建的待办
3. 标题或标签不匹配搜索关键词

### Q2：可以同时使用推荐和手动添加吗？

**A**：可以！
- 推荐和手动添加的待办都会出现在"已选择的关系"中
- 可以混合使用，发挥各自优势

### Q3：添加关系后可以修改类型吗？

**A**：可以！
- 在"已选择的关系"区域点击类型下拉框
- 选择新的关系类型即可

### Q4：如何知道关系是否创建成功？

**A**：保存待办后：
1. 在待办卡片上点击
2. 右侧抽屉会显示"关系上下文"
3. 查看是否有刚添加的关系

### Q5："生成分词"按钮没反应怎么办？

**A**：
1. 打开开发者工具（View → Toggle Developer Tools）
2. 查看 Console 输出
3. 如果没有输出，重启应用
4. 如果有错误，记录错误信息反馈

## 相关功能

- [关系上下文查看](./RELATIONS_USER_GUIDE.md)
- [关键词智能推荐](./功能实现说明-关键词智能推荐与AI集成.md)
- [待办管理基础](./README.md)

## 技术参考

- 关键词提取：使用 `segment` 中文分词
- 相似度计算：TF-IDF 算法
- 数据存储：SQLite 关系表

## 后续优化计划

1. **批量添加**：
   - 支持一次选择多个待办
   - 批量设置相同的关系类型

2. **关系预览**：
   - 在选择待办时预览其内容
   - 显示待办的状态和优先级

3. **智能建议**：
   - 根据历史关系模式提供建议
   - 自动识别常见的关系类型

4. **关系图谱**：
   - 可视化展示待办之间的关系网络
   - 支持拖拽调整关系

---

**版本**: 1.0.0  
**更新日期**: 2025-10-29  
**作者**: AI Assistant

