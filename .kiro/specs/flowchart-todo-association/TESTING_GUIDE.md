# 流程图关联功能测试指南

## 测试前准备

1. 确保应用已重新编译
2. 建议清空数据库或使用测试数据库
3. 准备一些测试待办任务

## 测试场景

### 场景 1: 创建流程图并验证数据库保存

**步骤：**
1. 启动应用
2. 点击工具栏的"流程图"按钮
3. 应用会自动创建一个空白流程图
4. 在流程图中添加一些节点

**预期结果：**
- 流程图成功创建
- 控制台显示：`[创建] 已保存到数据库: flowchart-xxxxx`
- 没有错误信息

**验证：**
- 关闭流程图抽屉，重新打开
- 流程图列表中应该显示刚创建的流程图
- 点击打开，节点应该正确显示

---

### 场景 2: 流程图级别关联（核心修复）

**步骤：**
1. 打开一个流程图
2. 在画布顶部的搜索栏中输入待办关键词
3. 从搜索结果中点击一个待办

**预期结果：**
- ✅ 显示"关联成功"提示
- ✅ 待办在搜索结果中显示"已关联"标识
- ❌ **不应该**出现 "FOREIGN KEY constraint failed" 错误

**验证：**
- 打开该待办的详情页
- 在"关联的流程图"区域应该看到刚才的流程图
- 点击流程图名称，应该能跳转到该流程图

---

### 场景 3: 节点级别关联

**步骤：**
1. 在流程图中创建一个新节点
2. 双击节点打开编辑面板
3. 在"关联待办"下拉框中选择一个待办
4. 保存节点

**预期结果：**
- ✅ 节点成功关联待办
- ✅ 节点显示待办标题
- ✅ 节点根据待办状态更新样式（如已完成显示绿色）
- ❌ **不应该**出现任何错误

**验证：**
- 刷新页面，重新打开流程图
- 节点仍然显示关联的待办信息
- 打开待办详情页，应该在"关联的流程图"区域看到节点级别的关联

---

### 场景 4: 取消关联

**步骤：**
1. 在流程图搜索栏中搜索已关联的待办
2. 点击已关联的待办（带"已关联"标识）

**预期结果：**
- ✅ 显示"取消关联成功"提示
- ✅ 待办的"已关联"标识消失

**验证：**
- 打开该待办的详情页
- "关联的流程图"区域不应该显示该流程图

---

### 场景 5: 删除流程图的级联删除

**步骤：**
1. 创建一个流程图并关联一些待办
2. 在流程图列表中删除该流程图
3. 打开之前关联的待办详情页

**预期结果：**
- ✅ 流程图成功删除
- ✅ 待办详情页的"关联的流程图"区域不再显示已删除的流程图
- ✅ 数据库中的关联记录被级联删除

---

### 场景 6: 删除待办的级联删除

**步骤：**
1. 创建一个流程图并关联一个待办
2. 删除该待办
3. 重新打开流程图

**预期结果：**
- ✅ 待办成功删除
- ✅ 流程图中的节点级别关联被清理（如果有）
- ✅ 数据库中的关联记录被级联删除

---

### 场景 7: 流程图重命名

**步骤：**
1. 在流程图列表中点击某个流程图的"重命名"按钮
2. 输入新名称并确认

**预期结果：**
- ✅ 流程图名称更新成功
- ✅ 数据库中的名称已更新

**验证：**
- 刷新页面，流程图列表中显示新名称
- 打开流程图，标题栏显示新名称

---

### 场景 8: 流程图导出

**步骤：**
1. 在流程图列表中点击某个流程图的"导出"按钮

**预期结果：**
- ✅ 成功下载 JSON 文件
- ✅ JSON 文件包含完整的流程图数据（schema, nodes, edges）

---

## 常见问题排查

### 问题 1: 仍然出现 "FOREIGN KEY constraint failed"

**可能原因：**
- 应用没有重新编译
- 使用了旧的 localStorage 数据

**解决方法：**
1. 完全关闭应用
2. 重新编译：`npm run build` 或 `npm run dev`
3. 清空 localStorage（开发者工具 > Application > Local Storage > Clear）
4. 重启应用

### 问题 2: 流程图列表为空

**可能原因：**
- 数据库中没有流程图数据
- localStorage 中的旧数据没有迁移

**解决方法：**
1. 创建一个新的流程图测试
2. 如果需要迁移旧数据，需要手动重新创建

### 问题 3: 关联显示不正确

**可能原因：**
- 缓存问题
- 数据同步延迟

**解决方法：**
1. 刷新页面
2. 重新打开流程图或待办详情页
3. 检查控制台是否有错误信息

---

## 性能测试

### 大量流程图测试
1. 创建 10+ 个流程图
2. 验证列表加载速度
3. 验证搜索功能正常

### 大量关联测试
1. 在一个流程图中关联 20+ 个待办
2. 验证搜索栏的性能
3. 验证待办详情页的加载速度

---

## 测试完成检查清单

- [ ] 场景 1: 创建流程图并验证数据库保存
- [ ] 场景 2: 流程图级别关联（核心修复）
- [ ] 场景 3: 节点级别关联
- [ ] 场景 4: 取消关联
- [ ] 场景 5: 删除流程图的级联删除
- [ ] 场景 6: 删除待办的级联删除
- [ ] 场景 7: 流程图重命名
- [ ] 场景 8: 流程图导出
- [ ] 性能测试：大量流程图
- [ ] 性能测试：大量关联

---

## 报告问题

如果在测试过程中发现问题，请记录：
1. 问题描述
2. 复现步骤
3. 预期结果 vs 实际结果
4. 控制台错误信息（如果有）
5. 截图（如果适用）
