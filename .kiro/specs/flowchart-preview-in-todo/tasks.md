# Implementation Plan: 待办详情中的流程图预览

## Overview

本实现计划描述了如何在待办详情中添加流程图预览功能。用户可以直接在待办详情页面查看关联流程图的完整内容，无需打开编辑器。点击预览后可以进入编辑模式。

## Tasks

- [x] 1. 创建流程图数据加载 Hook
  - 实现 `useFlowchartData` hook，支持数据加载、缓存和错误处理
  - 添加 LRU 缓存机制，限制最多缓存 20 个流程图
  - 实现加载超时检测（5秒）
  - _Requirements: 1.4, 5.1, 5.5_

- [ ]* 1.1 为 useFlowchartData 编写单元测试
  - 测试正常加载流程
  - 测试缓存命中和未命中场景
  - 测试错误处理和重试机制
  - _Requirements: 1.4, 5.1_

- [x] 2. 创建流程图预览画布组件
  - [x] 2.1 实现 FlowchartPreviewCanvas 组件
    - 使用 ReactFlow 渲染只读流程图
    - 禁用所有编辑功能（nodesDraggable=false, nodesConnectable=false）
    - 启用缩放和平移功能
    - 实现自动适应视图（fitView）
    - _Requirements: 1.2, 1.3, 3.1, 3.2, 3.3_

  - [x] 2.2 实现节点高亮功能
    - 根据 highlightedNodeId 高亮显示特定节点
    - 使用明显的视觉样式（蓝色边框、阴影、背景色）
    - 支持多个节点同时高亮
    - _Requirements: 7.1, 7.2, 7.3_

  - [ ]* 2.3 为 FlowchartPreviewCanvas 编写单元测试
    - 测试只读模式下编辑功能被禁用
    - 测试节点高亮样式正确应用
    - 测试缩放和平移功能
    - _Requirements: 3.1, 7.1_

- [x] 3. 创建流程图预览卡片组件
  - [x] 3.1 实现 FlowchartPreviewCard 组件
    - 显示流程图名称和描述
    - 集成 FlowchartPreviewCanvas
    - 实现加载状态（骨架屏）
    - 实现错误状态（错误提示和重试按钮）
    - 添加悬停效果（边框高亮、阴影）
    - _Requirements: 1.1, 1.4, 1.5, 2.2, 4.4_

  - [x] 3.2 实现点击跳转功能
    - 点击卡片打开流程图编辑器
    - 传递 flowchartId 和 highlightedNodeId
    - 双击也触发跳转
    - _Requirements: 2.1, 2.5, 7.4_

  - [ ]* 3.3 为 FlowchartPreviewCard 编写单元测试
    - 测试正常渲染
    - 测试加载和错误状态
    - 测试点击事件触发
    - _Requirements: 1.1, 2.1_

- [x] 4. 实现错误处理和降级方案
  - [x] 4.1 创建 PreviewErrorBoundary 组件
    - 捕获预览渲染错误
    - 显示友好的错误提示
    - 提供"打开编辑器"的备选方案
    - _Requirements: 8.5_

  - [x] 4.2 实现各种错误场景的处理
    - 流程图不存在：显示"已删除"提示
    - 加载超时：显示超时提示和重试按钮
    - 数据损坏：显示错误提示和降级方案
    - 网络错误：显示连接错误和重试按钮
    - _Requirements: 8.1, 8.2, 8.3, 8.4_

  - [ ]* 4.3 为错误处理编写单元测试
    - 测试各种错误场景的处理
    - 测试错误边界捕获
    - 测试降级方案
    - _Requirements: 8.1, 8.5_

- [x] 5. 集成到 TodoViewDrawer
  - [x] 5.1 修改 TodoViewDrawer 组件
    - 替换原有的关联卡片列表为预览卡片
    - 为每个关联的流程图创建 FlowchartPreviewCard
    - 保持流程图级别和节点级别关联的区分
    - 传递正确的 highlightedNodeId
    - _Requirements: 1.1, 4.1, 4.4, 7.1_

  - [x] 5.2 实现多流程图预览布局
    - 使用可滚动的垂直布局
    - 按关联创建时间排序
    - 每个预览卡片之间添加适当间距
    - _Requirements: 4.1, 4.2, 4.3_

  - [x] 5.3 连接点击事件到 App.tsx
    - 使用现有的 onOpenFlowchart 回调
    - 传递 flowchartId 和 nodeId
    - 确保正确跳转到流程图编辑器
    - _Requirements: 2.1, 4.5_

- [x] 6. 实现性能优化
  - [x] 6.1 实现懒加载
    - 使用 Intersection Observer
    - 只加载可视区域的预览
    - 显示占位符直到进入可视区域
    - _Requirements: 5.4_

  - [x] 6.2 实现异步加载
    - 预览加载不阻塞其他内容显示
    - 使用 React.Suspense（可选）
    - 显示加载进度
    - _Requirements: 5.2_

  - [ ]* 6.3 添加性能监控
    - 记录预览渲染时间
    - 对慢渲染（>1秒）发出警告
    - 收集性能数据用于优化
    - _Requirements: 5.3_

- [x] 7. 实现响应式布局
  - [x] 7.1 添加响应式样式
    - 大屏：预览高度 300px
    - 中屏：预览高度 250px
    - 小屏：预览高度 200px
    - _Requirements: 6.1, 6.2, 6.3_

  - [x] 7.2 实现自适应宽度
    - 预览宽度自动适应容器
    - 保持合理的宽高比
    - 处理特殊宽高比的流程图
    - _Requirements: 6.1, 6.5_

- [ ] 8. 添加用户配置选项（可选）
  - [ ] 8.1 添加预览开关设置
    - 在设置页面添加"启用流程图预览"选项
    - 默认启用
    - 禁用时回退到原有的卡片列表模式
    - _Requirements: 8.2_

  - [ ] 8.2 添加预览高度配置
    - 允许用户自定义预览高度
    - 提供预设选项：小（200px）、中（300px）、大（400px）
    - 保存到用户设置
    - _Requirements: 6.4_

- [x] 9. Checkpoint - 测试和验证
  - 手动测试所有功能
  - 验证性能表现
  - 检查错误处理
  - 确保所有测试通过
  - 询问用户是否有问题

- [ ] 10. 文档和清理
  - [ ] 10.1 更新用户文档
    - 添加流程图预览功能说明
    - 添加使用截图
    - 说明配置选项

  - [ ] 10.2 代码清理
    - 移除调试代码
    - 优化导入语句
    - 添加必要的注释
    - 确保代码风格一致

## Notes

- 本功能主要复用现有的 ReactFlow 组件和流程图渲染逻辑
- 预览模式下完全禁用编辑功能，确保数据安全
- 使用缓存和懒加载优化性能，避免影响待办详情的加载速度
- 提供完善的错误处理和降级方案，确保功能稳定性
- 响应式设计确保在不同屏幕尺寸下都有良好的体验
