# 排序和分组修复说明

## 修复日期
2025-10-27

## 问题描述

### 问题 1：手动排序无法保存
**现象**：在手动排序模式下，用户修改待办序号后，输入框中的数字保持，但待办位置没有移动。

**根本原因**：`TodoList.tsx` 中使用了旧的 `todo.displayOrder` 字段进行分组边界判断，而实际数据已迁移到 `todo.displayOrders[activeTab]`。这导致界面显示和实际数据不一致，分组逻辑失效。

### 问题 2：并列分组在时间排序时被拆散
**现象**：在创建时间排序模式下，有并列关系的待办没有保持在一起。

**根本原因**：`sortWithGroups.ts` 中的 `selectGroupRepresentatives` 函数固定选择"ID 最小"的待办作为组代表。但在时间排序时，ID 小不代表时间早，导致组间排序错误，并列待办被拆散。

**日志证据**（创建时间降序排序）：
```
位置 7: todo 5 (2025-10-22T12:21:53)
位置 8: todo 8 (2025-10-22T13:28:31)  ✅ 这一组是连在一起的
位置 9: todo 4 (2025-10-21 13:21:48)
位置 10: todo 9 (2025-10-22T14:40:09) ❌ 被 todo 1 拆散了
位置 11: todo 1 (2025-10-21 11:38:20)
位置 12: todo 2 (2025-10-21 12:25:36)  ✅ 这一组是连在一起的
```

## 修复方案

### 修复 1: `sortWithGroups.ts` - 优化代表选择策略

**文件**: `src/renderer/utils/sortWithGroups.ts`

**修改内容**:
1. 修改 `selectGroupRepresentatives` 函数签名，接受 `compareFn` 参数：
   ```typescript
   export function selectGroupRepresentatives(
     groups: Map<number, Set<number>>,
     todos: Todo[],
     compareFn: (a: Todo, b: Todo) => number  // 新增参数
   ): Map<Set<number>, Todo>
   ```

2. 修改代表选择逻辑，使用比较器而非固定 ID：
   ```typescript
   const representative = groupTodos.reduce((best, todo) =>
     compareFn(todo, best) < 0 ? todo : best
   );
   ```

**效果**: 
- 手动排序时：使用 ID 比较器，组代表是 ID 最小的
- 时间排序时：使用时间比较器，组代表是时间最早/最晚的
- 确保组代表符合当前排序规则，组间排序正确

### 修复 2: `App.tsx` - 传递正确的比较器

**文件**: `src/renderer/App.tsx`

**修改内容**:

1. **手动排序模式**（约 line 512-515）:
   ```typescript
   // 手动排序模式：使用 ID 比较器选择代表
   const manualComparator = (a: Todo, b: Todo) => (a.id || 0) - (b.id || 0);
   const groupRepresentatives = selectGroupRepresentatives(
     parallelGroups, 
     filtered, 
     manualComparator
   );
   ```

2. **时间排序模式**（约 line 553-558）:
   ```typescript
   // 获取排序比较器
   const comparator = getSortComparator(sortOption);
   
   // 使用时间比较器选择代表
   const groupRepresentatives = selectGroupRepresentatives(
     parallelGroups, 
     filtered, 
     comparator
   );
   ```

**效果**: 
- 不同排序模式使用不同的比较器选择组代表
- 确保组间排序和整体排序规则一致

### 修复 3: `TodoList.tsx` - 修正分组边界判断

**文件**: `src/renderer/components/TodoList.tsx`

**修改内容**（约 line 351-373）:

1. 新增相邻待办序号计算：
   ```typescript
   // 获取相邻待办的显示序号
   const prevDisplayOrder = prevTodo?.displayOrders?.[activeTab];
   const nextDisplayOrder = nextTodo?.displayOrders?.[activeTab];
   ```

2. 修正分组判断逻辑，使用 `currentDisplayOrder` 和新的相邻序号：
   ```typescript
   const isInGroup = sortOption === 'manual' && 
     currentDisplayOrder != null &&  // 使用 currentDisplayOrder
     isInParallelGroup &&
     (
       (prevTodo && prevDisplayOrder === currentDisplayOrder && ...) ||
       (nextTodo && nextDisplayOrder === currentDisplayOrder && ...)
     );
   
   const isGroupStart = isInGroup && (!prevTodo || prevDisplayOrder !== currentDisplayOrder || ...);
   const isGroupEnd = isInGroup && (!nextTodo || nextDisplayOrder !== currentDisplayOrder || ...);
   ```

**效果**: 
- 分组边界判断基于当前 tab 的 `displayOrders[activeTab]`
- 与数据库实际存储的字段一致
- 修复手动排序模式下的序号显示和分组判断

## 验证方法

### 验证 1: 手动排序保存
1. 切换到"手动排序"模式
2. 给某个待办填写新的序号（例如从 2 改为 5）
3. 按回车或点击其他地方保存
4. **预期结果**：
   - 序号保存成功
   - 待办移动到正确位置
   - 如果该待办有并列关系，并列的其他待办一起移动

### 验证 2: 并列分组在时间排序
1. 创建几个有并列关系的待办（确保它们的创建时间不同）
2. 切换到"创建时间-降序"模式
3. 打开开发者工具（F12），查看 Console
4. **预期结果**：
   - 并列关系的待办保持在一起
   - 日志中 `isGroupMember: true` 的待办相邻显示
   - 组的位置由组内时间最晚的待办决定

### 验证 3: 切换 Tab 序号独立
1. 在"全部"tab 中给待办设置序号（例如序号 3）
2. 切换到"待办"tab，给同一个待办设置不同序号（例如序号 7）
3. 在两个 tab 之间切换
4. **预期结果**：
   - 每个 tab 显示和保存自己的序号
   - 序号不会相互影响
   - 分组边界判断基于当前 tab 的序号

## 技术总结

这次修复的核心是**确保代表选择策略与排序规则一致**：

| 排序模式 | 比较器 | 组代表选择 | 组间排序依据 |
|---------|--------|-----------|------------|
| 手动排序 | ID 比较 | ID 最小的 | ID 最小的代表的序号 |
| 创建时间-升序 | 创建时间升序 | 时间最早的 | 时间最早的代表的时间 |
| 创建时间-降序 | 创建时间降序 | 时间最晚的 | 时间最晚的代表的时间 |
| 截止时间-升序 | 截止时间升序 | 截止最早的 | 截止最早的代表的截止时间 |
| 截止时间-降序 | 截止时间降序 | 截止最晚的 | 截止最晚的代表的截止时间 |

通过这种设计，无论使用哪种排序规则，并列分组都能保持在一起，且组的位置符合整体排序逻辑。

## 相关文件

- `src/renderer/utils/sortWithGroups.ts` - 分组排序工具函数
- `src/renderer/App.tsx` - 主应用组件，调用分组排序逻辑
- `src/renderer/components/TodoList.tsx` - 待办列表组件，显示和编辑序号
- `src/shared/types.ts` - Todo 类型定义（displayOrders 字段）
- `src/main/database/DatabaseManager.ts` - 数据库迁移逻辑

## 下一步

等待 GitHub Actions 构建完成后，下载最新版本进行测试。重点验证：
1. 手动排序序号保存和位置移动
2. 并列分组在各种时间排序模式下的表现
3. 多 Tab 序号独立性


