# è·¨å¹³å°æ‰“åŒ…é…ç½®å®Œæˆè¯´æ˜

## âœ… å·²å®Œæˆé…ç½®

æ‰€æœ‰è·¨å¹³å°æ‰“åŒ…ç›¸å…³çš„é…ç½®å·²å®Œæˆï¼Œç¡®ä¿åº”ç”¨åœ¨ Windows å’Œ macOS ä¸Šéƒ½èƒ½æ­£å¸¸æ„å»ºå’Œè¿è¡Œã€‚

## ğŸ“¦ é…ç½®å†…å®¹æ¦‚è§ˆ

### 1. package.json ä¼˜åŒ–

#### asarUnpack é…ç½®
```json
"asarUnpack": [
  "node_modules/better-sqlite3/**/*",
  // segment æ˜¯çº¯ JS åº“ï¼Œæ— éœ€ unpack
]
```
- æ’é™¤åŸç”Ÿæ¨¡å—ä¸æ‰“åŒ…åˆ° asar
- ç¡®ä¿åŸç”Ÿæ¨¡å—èƒ½è¢«æ­£ç¡®åŠ è½½

#### æ„å»ºè„šæœ¬ä¼˜åŒ–
- `prebuild`: æ„å»ºå‰è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒå’Œé‡å»ºåŸç”Ÿæ¨¡å—
- `postinstall`: å®‰è£…åè‡ªåŠ¨å¤„ç†ä¾èµ–
- `verify`: éªŒè¯åŸç”Ÿæ¨¡å—æ˜¯å¦æ­£å¸¸å·¥ä½œ

#### æ–‡ä»¶è¿‡æ»¤ä¼˜åŒ–
- æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶å‡å°åŒ…ä½“ç§¯
- ä¿ç•™åŸç”Ÿæ¨¡å—çš„æ‰€æœ‰å¿…è¦æ–‡ä»¶
- æ’é™¤æµ‹è¯•æ–‡ä»¶å’Œæ–‡æ¡£

### 2. éªŒè¯è„šæœ¬

#### scripts/prebuild-check.js
**åŠŸèƒ½**:
- âœ… æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼ˆ>= 16.xï¼‰
- âœ… æ£€æŸ¥ npm ç‰ˆæœ¬
- âœ… æ£€æŸ¥ Windows æ„å»ºå·¥å…·
- âœ… æ£€æŸ¥ macOS Xcode å·¥å…·
- âœ… éªŒè¯ä¾èµ–å®‰è£…
- âœ… æ£€æŸ¥åŸç”Ÿæ¨¡å—ç¼–è¯‘çŠ¶æ€
- âœ… æ£€æŸ¥ dist ç›®å½•

**ä½¿ç”¨**:
```bash
npm run prebuild
```

#### scripts/verify-native-modules.js
**åŠŸèƒ½**:
- âœ… éªŒè¯ better-sqlite3 åŠ è½½å’ŒåŠŸèƒ½
- âœ… éªŒè¯ segment åŠ è½½å’Œåˆ†è¯åŠŸèƒ½
- âœ… æ˜¾ç¤ºè¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
- âœ… æä¾›é”™è¯¯ä¿®å¤å»ºè®®

**ä½¿ç”¨**:
```bash
npm run verify
```

### 3. GitHub Actions CI/CD

#### .github/workflows/build.yml
**åŠŸèƒ½**:
- âœ… Windows x64 è‡ªåŠ¨æ„å»º
- âœ… macOS x64 (Intel) è‡ªåŠ¨æ„å»º
- âœ… macOS ARM64 (Apple Silicon) è‡ªåŠ¨æ„å»º
- âœ… åŸç”Ÿæ¨¡å—è‡ªåŠ¨é‡å»º
- âœ… æ„å»ºäº§ç‰©è‡ªåŠ¨ä¸Šä¼ 
- âœ… è‡ªåŠ¨åˆ›å»º GitHub Release

**è§¦å‘æ¡ä»¶**:
- æ¨é€åˆ° main/dev åˆ†æ”¯
- åˆ›å»º tag (v*)
- æ‰‹åŠ¨è§¦å‘

**äº§ç‰©**:
- Windows: `MultiTodo-*-x64-setup.exe`
- macOS Intel: `MultiTodo-*-x64.dmg`
- macOS Apple Silicon: `MultiTodo-*-arm64.dmg`

### 4. æ–‡æ¡£

#### BUILD.md - æ„å»ºæŒ‡å—
åŒ…å«ï¼š
- å‰ç½®è¦æ±‚ï¼ˆWindows/macOSï¼‰
- å¿«é€Ÿå¼€å§‹æ­¥éª¤
- æ„å»ºæµç¨‹è¯¦è§£
- å¸¸è§é—®é¢˜è§£å†³
- è°ƒè¯•æŠ€å·§
- CI/CD è¯´æ˜

#### RELEASE.md - å‘å¸ƒæµç¨‹
åŒ…å«ï¼š
- å‘å¸ƒæ£€æŸ¥æ¸…å•
- ç‰ˆæœ¬å·ç®¡ç†
- å‘å¸ƒæ­¥éª¤è¯¦è§£
- å¯†é’¥é…ç½®è¯´æ˜
- å‘å¸ƒæµ‹è¯•æµç¨‹
- çƒ­ä¿®å¤æµç¨‹

## ğŸš€ ä½¿ç”¨æŒ‡å—

### é¦–æ¬¡è®¾ç½®

```bash
cd MultiTodoApp

# 1. å®‰è£…ä¾èµ–
npm install

# 2. éªŒè¯ç¯å¢ƒ
npm run prebuild

# 3. éªŒè¯åŸç”Ÿæ¨¡å—
npm run verify

# 4. å¼€å‘æ¨¡å¼æµ‹è¯•
npm run dev
```

### æœ¬åœ°æ„å»ºæµ‹è¯•

```bash
# å®Œæ•´æ„å»ºæµç¨‹
npm run prebuild    # ç¯å¢ƒæ£€æŸ¥ + åŸç”Ÿæ¨¡å—é‡å»º
npm run build       # ç¼–è¯‘ TypeScript å’Œ Webpack
npm run dist        # æ‰“åŒ…ä¸ºå®‰è£…ç¨‹åº

# å¹³å°ç‰¹å®šæ„å»º
npm run dist:win    # ä»… Windows
npm run dist:mac    # ä»… macOS
```

### CI/CD å‘å¸ƒ

```bash
# 1. æ›´æ–°ç‰ˆæœ¬å·
npm version patch   # æˆ– minor/major

# 2. æ›´æ–° CHANGELOG.md
# ç¼–è¾‘æ–‡ä»¶æ·»åŠ æ›´æ–°å†…å®¹

# 3. æäº¤å¹¶åˆ›å»ºæ ‡ç­¾
git add .
git commit -m "chore: release v1.0.1"
git tag -a v1.0.1 -m "Release v1.0.1"

# 4. æ¨é€åˆ° GitHubï¼ˆè§¦å‘è‡ªåŠ¨æ„å»ºï¼‰
git push origin main --tags
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### Windows æ„å»º

1. **éœ€è¦å®‰è£… Visual Studio Build Tools**
   - ä¸‹è½½: https://visualstudio.microsoft.com/zh-hans/downloads/
   - é€‰æ‹©: "ä½¿ç”¨ C++ çš„æ¡Œé¢å¼€å‘" å·¥ä½œè´Ÿè½½

2. **é¦–æ¬¡æ„å»ºæ—¶**
   ```bash
   # å¯èƒ½éœ€è¦ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
   npm install --global windows-build-tools
   ```

### macOS æ„å»º

1. **éœ€è¦ Xcode Command Line Tools**
   ```bash
   xcode-select --install
   ```

2. **Apple Silicon (M1/M2) æ³¨æ„**
   - éœ€è¦ Rosetta 2 æ¥æ„å»º x64 ç‰ˆæœ¬
   - ARM64 ç‰ˆæœ¬ä¼šè‡ªåŠ¨äº¤å‰ç¼–è¯‘

3. **ä»£ç ç­¾åï¼ˆå¯é€‰ï¼‰**
   - éœ€è¦ Apple Developer è´¦å·
   - é…ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡æˆ– GitHub Secrets

### åŸç”Ÿæ¨¡å—

1. **å¿…é¡»é‡æ–°ç¼–è¯‘**
   - å®‰è£…å: `npm run rebuild`
   - æ›´æ–° Electron ç‰ˆæœ¬åä¹Ÿéœ€è¦é‡å»º

2. **éªŒè¯æ˜¯å¦æ­£å¸¸**
   ```bash
   npm run verify
   ```

3. **å¦‚æœåŠ è½½å¤±è´¥**
   ```bash
   # æ¸…ç†å¹¶é‡æ–°å®‰è£…
   rm -rf node_modules
   npm install
   npm run rebuild
   ```

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ï¼šåŸç”Ÿæ¨¡å—åŠ è½½å¤±è´¥

**ç—‡çŠ¶**: 
```
Error: Cannot find module 'xxx.node'
```

**è§£å†³**:
```bash
npm run rebuild
npm run verify
```

### é—®é¢˜ï¼šæ„å»ºå¤±è´¥

**ç—‡çŠ¶**: 
```
electron-builder æŠ¥é”™
```

**è§£å†³**:
```bash
# 1. æ£€æŸ¥ç¯å¢ƒ
npm run prebuild

# 2. æ¸…ç†é‡å»º
rm -rf release dist
npm run build
npm run dist
```

### é—®é¢˜ï¼šCI æ„å»ºå¤±è´¥

**æ£€æŸ¥**:
1. GitHub Actions æ—¥å¿—
2. åŸç”Ÿæ¨¡å—æ˜¯å¦æ­£ç¡®ç¼–è¯‘
3. å¹³å°ç‰¹å®šçš„æ„å»ºå·¥å…·æ˜¯å¦å¯ç”¨

## ğŸ“ å¾…åŠäº‹é¡¹

### macOS å›¾æ ‡

**æ³¨æ„**: å½“å‰é…ç½®å¼•ç”¨ `assets/icon.icns`ï¼Œä½†é¡¹ç›®ä¸­å¯èƒ½åªæœ‰ PNG å›¾æ ‡ã€‚

**ç”Ÿæˆ .icns æ–‡ä»¶**:

#### æ–¹æ³•1: ä½¿ç”¨åœ¨çº¿å·¥å…·
- è®¿é—®: https://cloudconvert.com/png-to-icns
- ä¸Šä¼  `assets/icon_512x512.png`
- ä¸‹è½½ç”Ÿæˆçš„ `icon.icns`
- æ”¾ç½®åˆ° `assets/` ç›®å½•

#### æ–¹æ³•2: ä½¿ç”¨ macOS å‘½ä»¤è¡Œ
```bash
cd assets

# åˆ›å»º iconset ç›®å½•
mkdir icon.iconset

# ç”Ÿæˆå„å°ºå¯¸å›¾æ ‡ï¼ˆéœ€è¦ sips å‘½ä»¤ï¼‰
sips -z 16 16     icon_512x512.png --out icon.iconset/icon_16x16.png
sips -z 32 32     icon_512x512.png --out icon.iconset/icon_16x16@2x.png
sips -z 32 32     icon_512x512.png --out icon.iconset/icon_32x32.png
sips -z 64 64     icon_512x512.png --out icon.iconset/icon_32x32@2x.png
sips -z 128 128   icon_512x512.png --out icon.iconset/icon_128x128.png
sips -z 256 256   icon_512x512.png --out icon.iconset/icon_128x128@2x.png
sips -z 256 256   icon_512x512.png --out icon.iconset/icon_256x256.png
sips -z 512 512   icon_512x512.png --out icon.iconset/icon_256x256@2x.png
sips -z 512 512   icon_512x512.png --out icon.iconset/icon_512x512.png
cp icon_512x512.png icon.iconset/icon_512x512@2x.png

# ç”Ÿæˆ icns
iconutil -c icns icon.iconset

# æ¸…ç†
rm -rf icon.iconset
```

#### æ–¹æ³•3: ä½¿ç”¨ç°æœ‰ PNGï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
å¦‚æœæš‚æ—¶æ²¡æœ‰ .icnsï¼Œå¯ä»¥ä¿®æ”¹ package.json:
```json
"mac": {
  "icon": "assets/icon_512x512.png"
}
```

## âœ… é…ç½®æ¸…å•

- [x] package.json ä¼˜åŒ–é…ç½®
- [x] asarUnpack åŸç”Ÿæ¨¡å—æ’é™¤
- [x] æ„å»ºè„šæœ¬ä¼˜åŒ–
- [x] ç¯å¢ƒæ£€æŸ¥è„šæœ¬
- [x] åŸç”Ÿæ¨¡å—éªŒè¯è„šæœ¬
- [x] GitHub Actions CI/CD
- [x] Windows æ„å»ºé…ç½®
- [x] macOS æ„å»ºé…ç½®
- [x] æ„å»ºæ–‡æ¡£
- [x] å‘å¸ƒæµç¨‹æ–‡æ¡£
- [ ] macOS .icns å›¾æ ‡ï¼ˆå¯é€‰ï¼‰

## ğŸ“š ç›¸å…³æ–‡ä»¶

### é…ç½®æ–‡ä»¶
- `package.json` - æ„å»ºé…ç½®
- `.github/workflows/build.yml` - CI/CD é…ç½®

### è„šæœ¬æ–‡ä»¶
- `scripts/prebuild-check.js` - æ„å»ºå‰æ£€æŸ¥
- `scripts/verify-native-modules.js` - åŸç”Ÿæ¨¡å—éªŒè¯

### æ–‡æ¡£æ–‡ä»¶
- `BUILD.md` - æ„å»ºæŒ‡å—
- `RELEASE.md` - å‘å¸ƒæµç¨‹
- `è·¨å¹³å°æ‰“åŒ…é…ç½®å®Œæˆè¯´æ˜.md` - æœ¬æ–‡ä»¶

## ğŸ¯ æµ‹è¯•éªŒè¯

### æœ¬åœ°æµ‹è¯•

```bash
# 1. ç¯å¢ƒæ£€æŸ¥
npm run prebuild
# é¢„æœŸï¼šæ‰€æœ‰æ£€æŸ¥é€šè¿‡

# 2. åŸç”Ÿæ¨¡å—éªŒè¯
npm run verify
# é¢„æœŸï¼šbetter-sqlite3 å’Œ segment éƒ½éªŒè¯é€šè¿‡

# 3. æ„å»ºæµ‹è¯•
npm run build
# é¢„æœŸï¼šæ— é”™è¯¯ï¼Œç”Ÿæˆ dist ç›®å½•

# 4. æ‰“åŒ…æµ‹è¯•
npm run dist
# é¢„æœŸï¼šç”Ÿæˆå®‰è£…åŒ…åœ¨ release ç›®å½•
```

### CI/CD æµ‹è¯•

1. æ¨é€ä»£ç åˆ° dev åˆ†æ”¯
2. æŸ¥çœ‹ GitHub Actions æ„å»ºçŠ¶æ€
3. ä¸‹è½½æ„å»ºäº§ç‰©æµ‹è¯•

## ğŸ’¡ åç»­å»ºè®®

1. **ç”Ÿæˆ macOS .icns å›¾æ ‡**
   - ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ä¹‹ä¸€ç”Ÿæˆ
   - æ”¾ç½®åˆ° assets ç›®å½•

2. **é…ç½®ä»£ç ç­¾å**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
   - è·å– Apple Developer è¯ä¹¦
   - é…ç½® GitHub Secrets

3. **æ·»åŠ è‡ªåŠ¨æ›´æ–°**
   - é›†æˆ electron-updater
   - é…ç½®æ›´æ–°æœåŠ¡å™¨

4. **æ·»åŠ å´©æºƒæŠ¥å‘Š**
   - é›†æˆ Sentry æˆ–ç±»ä¼¼æœåŠ¡
   - æ”¶é›†ç”¨æˆ·åé¦ˆ

## ğŸ‰ æ€»ç»“

æ‰€æœ‰è·¨å¹³å°æ‰“åŒ…æ‰€éœ€çš„é…ç½®å·²å…¨éƒ¨å®Œæˆï¼

ç°åœ¨æ‚¨å¯ä»¥ï¼š
- âœ… åœ¨ Windows ä¸Šæ„å»ºåº”ç”¨
- âœ… åœ¨ macOS ä¸Šæ„å»ºåº”ç”¨ï¼ˆIntel + Apple Siliconï¼‰
- âœ… ä½¿ç”¨ GitHub Actions è‡ªåŠ¨æ„å»º
- âœ… éªŒè¯åŸç”Ÿæ¨¡å—æ˜¯å¦æ­£å¸¸å·¥ä½œ
- âœ… æ£€æŸ¥æ„å»ºç¯å¢ƒæ˜¯å¦æ»¡è¶³è¦æ±‚
- âœ… æŒ‰ç…§æ ‡å‡†æµç¨‹å‘å¸ƒæ–°ç‰ˆæœ¬

**ä¸‹ä¸€æ­¥**: è¿è¡Œ `npm install` å’Œ `npm run verify` éªŒè¯é…ç½®ï¼

---

**é…ç½®ç‰ˆæœ¬**: v1.0  
**å®Œæˆæ—¶é—´**: 2025-10-28  
**çŠ¶æ€**: âœ… å®Œæˆ

