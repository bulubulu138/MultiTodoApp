# 跨平台打包配置完成说明

## ✅ 已完成配置

所有跨平台打包相关的配置已完成，确保应用在 Windows 和 macOS 上都能正常构建和运行。

## 📦 配置内容概览

### 1. package.json 优化

#### asarUnpack 配置
```json
"asarUnpack": [
  "node_modules/better-sqlite3/**/*",
  // segment 是纯 JS 库，无需 unpack
]
```
- 排除原生模块不打包到 asar
- 确保原生模块能被正确加载

#### 构建脚本优化
- `prebuild`: 构建前自动检查环境和重建原生模块
- `postinstall`: 安装后自动处理依赖
- `verify`: 验证原生模块是否正常工作

#### 文件过滤优化
- 排除不必要的文件减小包体积
- 保留原生模块的所有必要文件
- 排除测试文件和文档

### 2. 验证脚本

#### scripts/prebuild-check.js
**功能**:
- ✅ 检查 Node.js 版本（>= 16.x）
- ✅ 检查 npm 版本
- ✅ 检查 Windows 构建工具
- ✅ 检查 macOS Xcode 工具
- ✅ 验证依赖安装
- ✅ 检查原生模块编译状态
- ✅ 检查 dist 目录

**使用**:
```bash
npm run prebuild
```

#### scripts/verify-native-modules.js
**功能**:
- ✅ 验证 better-sqlite3 加载和功能
- ✅ 验证 segment 加载和分词功能
- ✅ 显示详细的诊断信息
- ✅ 提供错误修复建议

**使用**:
```bash
npm run verify
```

### 3. GitHub Actions CI/CD

#### .github/workflows/build.yml
**功能**:
- ✅ Windows x64 自动构建
- ✅ macOS x64 (Intel) 自动构建
- ✅ macOS ARM64 (Apple Silicon) 自动构建
- ✅ 原生模块自动重建
- ✅ 构建产物自动上传
- ✅ 自动创建 GitHub Release

**触发条件**:
- 推送到 main/dev 分支
- 创建 tag (v*)
- 手动触发

**产物**:
- Windows: `MultiTodo-*-x64-setup.exe`
- macOS Intel: `MultiTodo-*-x64.dmg`
- macOS Apple Silicon: `MultiTodo-*-arm64.dmg`

### 4. 文档

#### BUILD.md - 构建指南
包含：
- 前置要求（Windows/macOS）
- 快速开始步骤
- 构建流程详解
- 常见问题解决
- 调试技巧
- CI/CD 说明

#### RELEASE.md - 发布流程
包含：
- 发布检查清单
- 版本号管理
- 发布步骤详解
- 密钥配置说明
- 发布测试流程
- 热修复流程

## 🚀 使用指南

### 首次设置

```bash
cd MultiTodoApp

# 1. 安装依赖
npm install

# 2. 验证环境
npm run prebuild

# 3. 验证原生模块
npm run verify

# 4. 开发模式测试
npm run dev
```

### 本地构建测试

```bash
# 完整构建流程
npm run prebuild    # 环境检查 + 原生模块重建
npm run build       # 编译 TypeScript 和 Webpack
npm run dist        # 打包为安装程序

# 平台特定构建
npm run dist:win    # 仅 Windows
npm run dist:mac    # 仅 macOS
```

### CI/CD 发布

```bash
# 1. 更新版本号
npm version patch   # 或 minor/major

# 2. 更新 CHANGELOG.md
# 编辑文件添加更新内容

# 3. 提交并创建标签
git add .
git commit -m "chore: release v1.0.1"
git tag -a v1.0.1 -m "Release v1.0.1"

# 4. 推送到 GitHub（触发自动构建）
git push origin main --tags
```

## ⚠️ 重要注意事项

### Windows 构建

1. **需要安装 Visual Studio Build Tools**
   - 下载: https://visualstudio.microsoft.com/zh-hans/downloads/
   - 选择: "使用 C++ 的桌面开发" 工作负载

2. **首次构建时**
   ```bash
   # 可能需要以管理员身份运行
   npm install --global windows-build-tools
   ```

### macOS 构建

1. **需要 Xcode Command Line Tools**
   ```bash
   xcode-select --install
   ```

2. **Apple Silicon (M1/M2) 注意**
   - 需要 Rosetta 2 来构建 x64 版本
   - ARM64 版本会自动交叉编译

3. **代码签名（可选）**
   - 需要 Apple Developer 账号
   - 配置相应的环境变量或 GitHub Secrets

### 原生模块

1. **必须重新编译**
   - 安装后: `npm run rebuild`
   - 更新 Electron 版本后也需要重建

2. **验证是否正常**
   ```bash
   npm run verify
   ```

3. **如果加载失败**
   ```bash
   # 清理并重新安装
   rm -rf node_modules
   npm install
   npm run rebuild
   ```

## 🔍 故障排除

### 问题：原生模块加载失败

**症状**: 
```
Error: Cannot find module 'xxx.node'
```

**解决**:
```bash
npm run rebuild
npm run verify
```

### 问题：构建失败

**症状**: 
```
electron-builder 报错
```

**解决**:
```bash
# 1. 检查环境
npm run prebuild

# 2. 清理重建
rm -rf release dist
npm run build
npm run dist
```

### 问题：CI 构建失败

**检查**:
1. GitHub Actions 日志
2. 原生模块是否正确编译
3. 平台特定的构建工具是否可用

## 📝 待办事项

### macOS 图标

**注意**: 当前配置引用 `assets/icon.icns`，但项目中可能只有 PNG 图标。

**生成 .icns 文件**:

#### 方法1: 使用在线工具
- 访问: https://cloudconvert.com/png-to-icns
- 上传 `assets/icon_512x512.png`
- 下载生成的 `icon.icns`
- 放置到 `assets/` 目录

#### 方法2: 使用 macOS 命令行
```bash
cd assets

# 创建 iconset 目录
mkdir icon.iconset

# 生成各尺寸图标（需要 sips 命令）
sips -z 16 16     icon_512x512.png --out icon.iconset/icon_16x16.png
sips -z 32 32     icon_512x512.png --out icon.iconset/icon_16x16@2x.png
sips -z 32 32     icon_512x512.png --out icon.iconset/icon_32x32.png
sips -z 64 64     icon_512x512.png --out icon.iconset/icon_32x32@2x.png
sips -z 128 128   icon_512x512.png --out icon.iconset/icon_128x128.png
sips -z 256 256   icon_512x512.png --out icon.iconset/icon_128x128@2x.png
sips -z 256 256   icon_512x512.png --out icon.iconset/icon_256x256.png
sips -z 512 512   icon_512x512.png --out icon.iconset/icon_256x256@2x.png
sips -z 512 512   icon_512x512.png --out icon.iconset/icon_512x512.png
cp icon_512x512.png icon.iconset/icon_512x512@2x.png

# 生成 icns
iconutil -c icns icon.iconset

# 清理
rm -rf icon.iconset
```

#### 方法3: 使用现有 PNG（临时方案）
如果暂时没有 .icns，可以修改 package.json:
```json
"mac": {
  "icon": "assets/icon_512x512.png"
}
```

## ✅ 配置清单

- [x] package.json 优化配置
- [x] asarUnpack 原生模块排除
- [x] 构建脚本优化
- [x] 环境检查脚本
- [x] 原生模块验证脚本
- [x] GitHub Actions CI/CD
- [x] Windows 构建配置
- [x] macOS 构建配置
- [x] 构建文档
- [x] 发布流程文档
- [ ] macOS .icns 图标（可选）

## 📚 相关文件

### 配置文件
- `package.json` - 构建配置
- `.github/workflows/build.yml` - CI/CD 配置

### 脚本文件
- `scripts/prebuild-check.js` - 构建前检查
- `scripts/verify-native-modules.js` - 原生模块验证

### 文档文件
- `BUILD.md` - 构建指南
- `RELEASE.md` - 发布流程
- `跨平台打包配置完成说明.md` - 本文件

## 🎯 测试验证

### 本地测试

```bash
# 1. 环境检查
npm run prebuild
# 预期：所有检查通过

# 2. 原生模块验证
npm run verify
# 预期：better-sqlite3 和 segment 都验证通过

# 3. 构建测试
npm run build
# 预期：无错误，生成 dist 目录

# 4. 打包测试
npm run dist
# 预期：生成安装包在 release 目录
```

### CI/CD 测试

1. 推送代码到 dev 分支
2. 查看 GitHub Actions 构建状态
3. 下载构建产物测试

## 💡 后续建议

1. **生成 macOS .icns 图标**
   - 使用上述方法之一生成
   - 放置到 assets 目录

2. **配置代码签名**（生产环境）
   - 获取 Apple Developer 证书
   - 配置 GitHub Secrets

3. **添加自动更新**
   - 集成 electron-updater
   - 配置更新服务器

4. **添加崩溃报告**
   - 集成 Sentry 或类似服务
   - 收集用户反馈

## 🎉 总结

所有跨平台打包所需的配置已全部完成！

现在您可以：
- ✅ 在 Windows 上构建应用
- ✅ 在 macOS 上构建应用（Intel + Apple Silicon）
- ✅ 使用 GitHub Actions 自动构建
- ✅ 验证原生模块是否正常工作
- ✅ 检查构建环境是否满足要求
- ✅ 按照标准流程发布新版本

**下一步**: 运行 `npm install` 和 `npm run verify` 验证配置！

---

**配置版本**: v1.0  
**完成时间**: 2025-10-28  
**状态**: ✅ 完成

