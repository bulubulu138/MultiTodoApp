# 手动排序功能实现总结

## 功能概述

已成功实现待办事项的手动排序功能，用户可以为每个待办事项设置一个显示序号，并通过工具栏选择"手动排序"模式来按序号显示待办列表。

## 实现的功能

### 1. 数据库架构更新
- ✅ 在 `todos` 表中添加了 `displayOrder` 列（INTEGER类型，可为空）
- ✅ 自动迁移脚本会在应用启动时检查并添加该列
- ✅ 更新了所有CRUD操作以支持 `displayOrder` 字段

### 2. 类型定义
- ✅ 在 `Todo` 接口中添加了 `displayOrder?: number` 字段
- ✅ 所有相关组件都能正确识别和使用该字段

### 3. 用户界面

#### 工具栏排序选项
- ✅ 添加了"手动排序"选项到排序下拉菜单
- ✅ 选项位于下拉菜单的第一位，方便用户快速访问
- ✅ 排序选项会保存到设置中，应用重启后保持

#### 待办表单
- ✅ 在编辑/新建待办表单中添加了"显示序号"输入框
- ✅ 位置：状态选择器之后，开始时间之前
- ✅ 字段特性：
  - 数字输入框，最小值为0
  - 可选字段（留空表示不使用手动排序）
  - 带有提示信息："用于手动排序，数字越小越靠前。留空则按默认规则排序"
  - 占据整行宽度，便于输入

### 4. 排序逻辑

#### 手动排序模式
当用户选择"手动排序"时：
1. 将待办事项分为两组：
   - 有 `displayOrder` 值的待办
   - 没有 `displayOrder` 值的待办
2. 有序号的待办按 `displayOrder` 升序排序（数字越小越靠前）
3. 无序号的待办按创建时间降序排序（新的在前）
4. 最终显示顺序：有序号的待办 → 无序号的待办

#### 其他排序模式
保持原有的排序逻辑不变：
- 按创建时间、开始时间、截止时间排序
- 维持逾期/活跃/已完成的分组逻辑

### 5. 适用范围
- ✅ 手动排序功能适用于所有标签页：
  - 全部
  - 待办
  - 进行中
  - 已完成
  - 已暂停

## 使用方法

### 设置待办的显示序号
1. 点击"新建待办"或编辑现有待办
2. 在表单中找到"显示序号"字段
3. 输入一个数字（0或更大）
   - 例如：1, 2, 3, 10, 100等
   - 数字越小，显示位置越靠前
4. 保存待办

### 应用手动排序
1. 在工具栏的排序下拉菜单中选择"手动排序"
2. 待办列表会立即重新排序
3. 设置了序号的待办会按序号排在前面
4. 未设置序号的待办会按创建时间排在后面

### 调整排序顺序
1. 编辑需要调整位置的待办
2. 修改其"显示序号"值
3. 保存后列表会自动更新

### 取消手动排序
1. 可以删除待办的"显示序号"（清空该字段）
2. 或者在工具栏选择其他排序方式（如"创建时间"）

## 技术实现细节

### 文件修改清单
1. `src/shared/types.ts` - 添加 displayOrder 字段到 Todo 接口
2. `src/main/database/DatabaseManager.ts` - 数据库迁移和CRUD操作
3. `src/renderer/components/Toolbar.tsx` - 添加手动排序选项
4. `src/renderer/components/TodoForm.tsx` - 添加显示序号输入框
5. `src/renderer/App.tsx` - 实现手动排序逻辑

### 数据库迁移
```typescript
if (!hasDisplayOrder) {
  this.db!.prepare('ALTER TABLE todos ADD COLUMN displayOrder INTEGER').run();
}
```

### 排序算法
```typescript
if (sortOption === 'manual') {
  const withOrder = filtered.filter(todo => todo.displayOrder != null);
  const withoutOrder = filtered.filter(todo => todo.displayOrder == null);
  
  withOrder.sort((a, b) => a.displayOrder! - b.displayOrder!);
  withoutOrder.sort((a, b) => {
    const aTime = new Date(a.createdAt).getTime();
    const bTime = new Date(b.createdAt).getTime();
    return bTime - aTime;
  });
  
  return [...withOrder, ...withoutOrder];
}
```

## 测试建议

### 基本功能测试
- [ ] 创建新待办并设置显示序号
- [ ] 创建新待办不设置显示序号
- [ ] 编辑现有待办添加显示序号
- [ ] 编辑现有待办删除显示序号
- [ ] 编辑现有待办修改显示序号

### 排序功能测试
- [ ] 选择"手动排序"查看效果
- [ ] 验证有序号的待办按序号排序
- [ ] 验证无序号的待办按创建时间排序
- [ ] 验证有序号的待办显示在无序号的待办之前
- [ ] 切换到其他排序方式，验证正常工作
- [ ] 切换回"手动排序"，验证状态保持

### 跨标签页测试
- [ ] 在"全部"标签页测试手动排序
- [ ] 在"待办"标签页测试手动排序
- [ ] 在"进行中"标签页测试手动排序
- [ ] 在"已完成"标签页测试手动排序
- [ ] 在"已暂停"标签页测试手动排序

### 边界情况测试
- [ ] 所有待办都有序号
- [ ] 所有待办都没有序号
- [ ] 多个待办有相同序号（应按创建时间次级排序）
- [ ] 序号为0的待办
- [ ] 序号很大的待办（如999999）
- [ ] 修改待办状态后排序是否正确

### 持久化测试
- [ ] 设置手动排序后重启应用，验证排序方式保持
- [ ] 设置待办序号后重启应用，验证序号保持
- [ ] 修改序号后刷新列表，验证立即生效

## 兼容性说明

- ✅ 向后兼容：现有待办数据不会受影响
- ✅ 数据库自动迁移：首次运行时自动添加 displayOrder 列
- ✅ 可选功能：用户可以选择不使用手动排序
- ✅ 不影响现有排序：其他排序方式继续正常工作

## 构建状态

✅ TypeScript编译成功
✅ Webpack打包成功
✅ 无linter错误

## 后续优化建议

1. **可视化序号显示**：在手动排序模式下，在待办卡片上显示序号徽章
2. **拖拽排序**：实现拖拽功能自动设置序号
3. **批量设置序号**：提供批量设置序号的工具
4. **序号自动调整**：插入新待办时自动调整其他待办的序号
5. **序号冲突提示**：当多个待办有相同序号时给出提示

## 总结

手动排序功能已完整实现并通过编译测试。该功能为用户提供了灵活的待办列表管理方式，可以根据个人偏好自定义待办的显示顺序，同时不影响现有的自动排序功能。

