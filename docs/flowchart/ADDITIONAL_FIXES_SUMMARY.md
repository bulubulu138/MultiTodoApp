# 流程图额外问题修复总结

## 修复日期
2025-01-01

## 修复的问题

### 1. 节点拖拽位置问题 ✅

**问题描述**:
- 新增节点时，松手后节点会跳到屏幕中央
- 已放置的节点位置也会发生变化

**根本原因**:
`useEffect` 中的节点更新逻辑过于简单，只检查了 `dragging` 和 `selected` 状态，导致新节点被错误地重新定位。

**解决方案**:
改进了 `FlowchartCanvas` 中的节点更新逻辑：
- 使用 Map 数据结构提高查找效率
- 区分新节点和已存在节点
- 只在节点拖动或选中时保留其当前位置
- 新节点直接使用持久化层的位置

**代码变更**:
```typescript
// 创建当前节点的 Map 以便快速查找
const currentNodesMap = new Map(currentNodes.map(n => [n.id, n]));

// 更新节点，保留运行时状态
const updatedNodes = newNodes.map(newNode => {
  const currentNode = currentNodesMap.get(newNode.id);
  
  if (currentNode) {
    // 节点已存在，保留其运行时状态
    return {
      ...newNode,
      position: (currentNode.dragging || currentNode.selected) 
        ? currentNode.position 
        : newNode.position,
      dragging: currentNode.dragging,
      selected: currentNode.selected
    };
  }
  
  // 新节点，直接使用
  return newNode;
});
```

**效果**:
- 新增节点准确放置在鼠标释放位置
- 已有节点位置保持稳定
- 拖动操作流畅不卡顿

---

### 2. 待办任务关联显示（待实现）⏳

**问题描述**:
- 当节点关联待办任务后，应在待办任务列表中显示关联的流程图节点信息

**建议方案**:
1. 在待办任务项中添加流程图节点指示器
2. 显示关联的流程图名称和节点名称
3. 点击可快速跳转到对应流程图

**实现位置**:
- `VirtualizedTodoList.tsx` - 待办任务列表组件
- 需要查询数据库获取关联信息

**注意事项**:
- 需要在数据库中建立反向索引（从 todoId 查找节点）
- 考虑性能影响，可能需要缓存
- UI 设计要简洁，不影响现有布局

---

### 3. 导出功能增强 ✅

**问题描述**:
- 导出的文本和 Mermaid 格式缺少重要业务信息
- 没有体现节点层级关系
- 没有包含待办任务详情

**解决方案**:

#### 3.1 文本导出增强

新增功能：
1. **层级计算**：使用拓扑排序算法计算节点层级
2. **待办任务信息**：显示关联任务的标题、状态、优先级、截止时间
3. **连接关系**：显示每个节点的输入和输出连接
4. **统计信息**：节点总数、连接总数、最大层级、节点类型分布

导出内容示例：
```
流程图: 项目开发流程
描述: 软件开发的标准流程
创建时间: 2025/1/1 10:00:00
更新时间: 2025/1/1 12:00:00

============================================================

节点列表（按层级）:

1. [node-1] 需求分析
   类型: 矩形
   层级: 0
   位置: (100, 100)
   关联任务: 完成需求文档
   任务状态: 进行中
   任务优先级: 高
   截止时间: 2025/1/5 18:00:00
   输出: 设计方案

  2. [node-2] 设计方案
     类型: 矩形
     层级: 1
     位置: (300, 100)
     输入: 需求分析
     输出: 开发实现

============================================================

统计信息:
  节点总数: 5
  连接总数: 4
  最大层级: 3
  关联任务: 3
  锁定节点: 1

节点类型分布:
  矩形: 3
  菱形（决策）: 1
  圆形（起止）: 1
```

#### 3.2 Mermaid 导出增强

新增功能：
1. **待办任务标记**：在节点标签中显示状态图标和优先级
2. **样式类**：根据待办状态自动应用颜色样式
3. **注释信息**：添加流程图元数据作为注释

导出内容示例：
```mermaid
flowchart TD

    %% 流程图: 项目开发流程
    %% 描述: 软件开发的标准流程
    %% 创建时间: 2025/1/1 10:00:00

    node_1[🔄 需求分析<br/>[高优先级]]
    class node_1 inProgressStyle

    node_2[设计方案]

    node_1 --> node_2

    %% 样式定义
    classDef pendingStyle fill:#fff3cd,stroke:#ffc107,stroke-width:2px
    classDef inProgressStyle fill:#cfe2ff,stroke:#0d6efd,stroke-width:2px
    classDef completedStyle fill:#d1e7dd,stroke:#198754,stroke-width:2px
    classDef pausedStyle fill:#e2e3e5,stroke:#6c757d,stroke-width:2px
```

**技术实现**:

1. **层级计算算法**（拓扑排序 + BFS）:
```typescript
private static calculateNodeLevels(
  nodes: PersistedNode[],
  edges: PersistedEdge[]
): Map<string, number> {
  // 1. 计算入度
  // 2. 找到所有起始节点（入度为0）
  // 3. BFS 遍历，计算每个节点的层级
  // 4. 层级 = 所有父节点的最大层级 + 1
}
```

2. **待办任务集成**:
- 导出方法新增 `todos?: Todo[]` 参数
- 创建 todoMap 快速查找
- 在节点信息中嵌入待办详情

3. **状态图标映射**:
```typescript
const icons = {
  'pending': '⏳',
  'in_progress': '🔄',
  'completed': '✅',
  'paused': '⏸️'
};
```

**效果**:
- 导出内容更加完整和专业
- 包含所有关键业务信息
- 层级关系清晰可见
- 待办任务状态一目了然
- 可直接用于文档和汇报

---

## 文件变更清单

### 修改的文件

1. **FlowchartCanvas.tsx**
   - 改进节点更新逻辑
   - 使用 Map 提高性能
   - 区分新节点和已存在节点

2. **TextExporter.ts**
   - 添加层级计算功能
   - 集成待办任务信息
   - 增强统计信息
   - 显示连接关系

3. **MermaidExporter.ts**
   - 添加待办任务标记
   - 自动应用状态样式
   - 添加元数据注释

4. **FlowchartDrawer.tsx**
   - 更新导出调用，传递 todos 参数

## 测试建议

### 1. 节点拖拽测试
- [ ] 从节点库拖拽新节点到画布
- [ ] 验证节点位置是否在鼠标释放位置
- [ ] 拖动已有节点，验证位置是否正确保存
- [ ] 快速连续添加多个节点
- [ ] 缩放画布后添加节点

### 2. 导出功能测试
- [ ] 导出纯文本格式，检查层级信息
- [ ] 导出包含待办任务的流程图
- [ ] 导出 Mermaid 格式，在 Mermaid 编辑器中预览
- [ ] 验证待办任务状态图标显示
- [ ] 检查统计信息准确性

### 3. 边界情况测试
- [ ] 导出空流程图
- [ ] 导出只有节点没有连接的流程图
- [ ] 导出有循环依赖的流程图
- [ ] 导出关联已删除待办的节点

## 已知限制

1. **待办任务显示**：
   - 待办任务列表中的流程图节点指示功能尚未实现
   - 需要额外的数据库查询和 UI 设计

2. **导出格式**：
   - PNG 导出不包含待办任务信息（图片格式限制）
   - JSON 导出不包含待办任务详情（只有 ID）

3. **性能考虑**：
   - 大型流程图（>100 节点）的层级计算可能较慢
   - 建议添加缓存机制

## 后续优化建议

1. **待办任务集成**：
   - 实现待办任务列表中的流程图节点指示
   - 添加快速跳转功能
   - 支持从待办任务直接创建流程图节点

2. **导出功能**：
   - 支持导出为 PDF 格式
   - 支持自定义导出模板
   - 添加导出预览功能

3. **性能优化**：
   - 缓存层级计算结果
   - 使用 Web Worker 处理大型流程图导出
   - 添加导出进度提示

4. **用户体验**：
   - 添加导出选项配置（选择包含哪些信息）
   - 支持批量导出多个流程图
   - 导出历史记录管理
